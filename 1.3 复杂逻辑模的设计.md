### 1.3 复杂逻辑模的设计

前面章节详细介绍了Verilog的语法，并通过8个简单例子给出了常见的逻辑电路设计套路。本节将讲述如何利用简单的Verilog描述实现复杂的逻辑电路。

对于复杂的逻辑电路，可能有很多的答案，但有一点是一定的：电路描述的信息熵很高。逻辑电路的复杂性通常表现在以下几个方面：①内部结构组成复杂；②控制状态复杂且高度耦合；③接口复杂且信号数量很多；④模块数量巨大。

站在工程学的角度，内部结构组成的复杂可以通过树状结构或网状结构进行消解，即通常所说的结构化设计（Hierarchy)和总线设计；<span style='color:red;;'>控制状态的复杂则可以通过控制流分解，</span>按照主从状态细化的方法降低单个组成单元的复杂度；而任何复杂的接口都可以简化为流量控制处理，并通过成熟的通信协议设计降低难度；数量巨大的模块可以通过分类整理，实现条理化、清晰化。因此，任何复杂的逻辑设计最终可以演变为：①对基本单元的归类整理和层次化设计，即结构化设计；②基本功能的单元设计，即数据流设计；③将层次化的基本单元进行梳理，最终形成全局电路控制，即控制流设计。

#### 1.3.1 结构化的设计

对于复杂的系统,需要按照结构化的方法进行设计。而芯片结构化设计中最重要的一点就是如何定义整体架构以及划分单元间的边界。架构划分的出发点通常包含:①能够改善模块的独立性和并行性;②改善EDA工具的运行时间或优化难度;③减少设计实现的面积。

改善模块的独立性和并行性的本质是增加吞吐量,并降低设计难度。这里面的关键就是对模块进行解耦,并对模块接口协议进行规范化。我们首先看如图1-62所示的例子。

图1-62表示有M个模块提供输出，这些输出数据提供给N个模块。这种网状交叉传递的行为方式必然会导致数据在这些模块之间进行非常复杂的流动，通常会造成牵一发而动全身的效果。如果修改一个模块的接口或时序，所有的关联模块都要被修改。这是一种典型的强耦合结构，不符合工程设计所要求的“高内聚、低耦合”和“信息隐蔽”的基本原则。

![image-20200325112635371](https://tva1.sinaimg.cn/large/00831rSTgy1gd60gz724fj30a407ygnb.jpg)

这种架构通常是在项目启动阶段、系统工程师接触到的原始需求构架。如果直接按  照原始架构转换为芯片设计架构,必然会导致芯片内各个模块形成网状耦合。而网状耦合实际上是不太符合人类逻辑思维方式的,会造  成工程人员的思维混乱。此外任意一个网络节点的修改必然会导致M×N个节点的同步修改;  如果网络节点是双向的,则会进一步扩散到全局,时序设计将变为一纸空谈。

##### 1. 结构化设计分类

标准的架构设计就是对复杂的网状结构进行化简,并将结构简化为如下几类的组合。

1. 顺序结构

这种结构如图1-63所示,其中各个模块的输入、输出均独立、互不干扰,数据和控制解耦最完全,能够实现最大吞吐率和最大并行化,这也是设计中首要追求的目标。

![image-20200325113848949](https://tva1.sinaimg.cn/large/00831rSTgy1gd60tnbajwj30e907zdhd.jpg)

2. 树状结构

这种结构如图1-64所示,呈典型树状结构,模块间只存在一个汇聚点,而子模块相互独立,互不干扰。整个树状结构只能由汇聚点输入或输出,整体充当一个节点与其他模块互联。

![image-20200325114159055](https://tva1.sinaimg.cn/large/00831rSTgy1gd60wy3efrj30a505pgmr.jpg)

这种结构适合在叶子节点较少时选用,但同样存在单点变化会对周边模块功能和时序造成影  响的问题,因此需要制定规则以保证在节点调整时,上下两层能够防止这种影响的扩散,而  仅需局部调整应对。

3. 总线结构

前面两类结构属于在结构明晰时使用的结构,通常要求信号和时序调整只能形成局部影响。而总线结构则是在网状耦合的M:N中,提  炼出一个中间的“1”,让M与“1”耦合,N  也与这个“1”耦合,具体情况如图1-65所示。

![image-20200325114250016](https://tva1.sinaimg.cn/large/00831rSTgy1gd60xttyetj30al086myq.jpg)

通过这种设计，上层的M个模块可以相互独立，并能够独立做任意修改，只要接口界面满足总线汇聚标准即可；而用于承接的N个模块也不关心输入源头，同样只需要满足总线汇聚规范即可。这种设计能够有效地化简网状结构的复杂性，设计特征也符合人类思维。

##### 2. 结构化设计的要点

1. 数据与控制分离

在阅读过程中,读者会发现本书反复强调数据与控制需要分离,无论是FSM还是结  构化设计或者后面所论述的大型芯片设计、  LTE-A网络、SDN、云计算构架等。在实践中  已经无数次证明:数据与控制分离(U/C分  离)是大型系统设计成功的关键因素之一。

在IC设计中,将数据的处理模块和控制的状态机分开的好处在于:①控制结构相对简单,调试比较方便;②数据流( Data Path)可以专门设计,并大量使用成熟的IP;③对于综  合工具而言,分离结构层次清晰,FSM易于提取,因此结构优化彻底。

在前面论述函数时，读者可以发现函数的设计其实就是一个完整的数据流。电路逻辑基本模型中的组合电路也是一个最小的数据流。这两种形式，其实就是一种控制与数据分开的设计风格。

2. 将相似逻辑或紧密关联逻辑划分到相同层次

这个道理是不言而喻的,将相似逻辑划分到相同层次,能够显著优化电路结构,便于综  合器提取层次结构,实现资源共享和布局优化。

图1-66是一个典型的层次化设计,其中的模块D与模块B1有较强的关联性或者功能相似,但一个位于层次二,一个位于层次三。这种情况下,EDA综合器通常无法跨层进行优化;

![image-20200325115209776](https://tva1.sinaimg.cn/large/00831rSTgy1gd617j98npj30a606c3zz.jpg)

而设计人员也很难通过简单手段梳理出模  块D与模块B1的直接关联关系。因此这种  设计是一种不太理想的结构化方案。

图1-67是按照相似逻辑划分到相同层次的方式,对图1-66模块进行优化重组的结果。

当模块B1与模块D位于同一层次后,逻辑层次相对清楚,而且综合器能够进行  深度优化。图1-68是一个相同层次模块合  并优化的示意图。

![image-20200325115420243](https://tva1.sinaimg.cn/large/00831rSTgy1gd619srbw3j30jd07e76p.jpg)

3. 使用寄存器作为模块的分界线

模块1与模块2之间的关系如图1-69所示。

![image-20200325115531532](https://tva1.sinaimg.cn/large/00831rSTgy1gd61b17brbj30fv04ymyg.jpg)

上述模块的分界方法不太理想,这是因为综合工具在综合时将优先考虑组合电路B和组合电路各自的优化,而且很难站在全局角度将电路B和C进行合并优化。此外,综合工具  的能力是有限的,如果按照保守约束方法进行输入、输出判断,最终模块1与模块2之间的时  序很难满足要求。综合工具通常只能帮助设计者完成设计细节,即将HDL语言翻译为电路,  并进行简单优化,目的是提高工作效率,而不是帮助设计者完成设计。因此边界模糊、不能  优化的事情需要设计者通过设计规则避免。如果上述模块按照如图1-70所示的方式进行分界,  电路将会获得较好的性能。

![image-20200325115911346](https://tva1.sinaimg.cn/large/00831rSTgy1gd61euhuu4j30eq05fq3x.jpg)

图1-70中的模块1和模块2都用寄存器作为模块设计的边界。在这种情况下,综合工具无须考虑模块边界,只需要专注于组合电路的优化。而且当组合电路AB被修改后,并不影响组合  电路CD的综合结果。因此利用寄存器进行模块分界有助于增强模块的重用性,便于电路优化。

#### 1.3.2 数据流的设计

数据流主要关注逻辑功能的实现，包括模块功能函数的实现、如何实现资源最大复用、如何集成IP等。本书后面的章节将重点描述各类功能函数，例如FIR、FFT的实现方法。此处主要为读者介绍在芯片设计时所用到的各种数据流模型以及接口概念。

数据流的实现模型可以套用软件开发中常见的生成者与消费者模型,即前级数据产生模块为生产者,数据处理模块为消费者,具体情况如图1-71所示。

![image-20200325120303576](https://tva1.sinaimg.cn/large/00831rSTgy1gd61iz57mij30gz05ijrq.jpg)

生产者与消费者模型的核心就是既不能让生产者爆仓,生成过多产品,又不能让任何一个消费者饿死。因此,数据流处理的核心就是保证数据产生模块产生的数据不会过多,进而  导致数据处理模块处理不了或者丢弃;同时也要保证数据处理模块处理速度不能太快,进而  导致很多无效的数据进入数据处理模块。

生产者与消费者模型在数字信号处理中的一个典型例子就是快速傅里叶变换(FFT)。 FFT通常需要一次性准备好$2^n$个数据输入,然后经过一段时间的计算后输出$2^n$个数据。因此  给FFT准备数据的模块(生产者),如果在FFT模块启动前未准备好$2^n$个数据,则FFT处理  模块(消费者)必然会陷入等待;如果FFT处理模块处理得过快,同样也会陷入等待;否则  就会出错。而一次性准备好$2^n$个数据,既不能多又不能少,这种要求是比较苛刻的,因此  FFT的输入通常采用如图1-72的接口形式,这在本节中被定义为被动流控接口。

借鉴生产者与消费者模型的接口协议,数据流接口可以划分为如下几类:

1. 无流控输入
2. 有流控输入
3. 无流控输出
4. 有流控输出
5. 数据快传递

![image-20200325120703887](https://tva1.sinaimg.cn/large/00831rSTgy1gd61n1jgqoj30gb07qmzq.jpg)

这几类方式是以数据传递是否存在控制协议以及是否成帧作为划分的基础。如果将接口约定进行正确的匹配，就能简化设计，降低复杂度。

对于IC电路中一对多与多对一的情况，可以通过添加控制逻辑，将此类模型简化为一对一的数据流模型，具体如图1-73所示。

![image-20200325120924539](https://tva1.sinaimg.cn/large/00831rSTgy1gd61phj4o4j30jz05ywh1.jpg)

由于在IC电路设计中不提倡多对多的设计,所以无须考虑此类模型。

##### 1. 无流控输入/输出

输入和输出之间速率能够匹配。包括输入频率、相位都要求一致。无流控输入移植性最差，外部要求高

![image-20200326090510426](https://tva1.sinaimg.cn/large/00831rSTgy1gd7204tzwqj30fb07pabt.jpg)

##### 2. 有流控输入/输出

输入和输出之间有控制协议，接收更具当前缓存状态和其他标志确定是否继续接收新的数据或通知发送方暂缓发送，其本质是保证输入输出长时间速率相等，如果两者速率不匹配，就要额外增加缓存。或者采用交互模式。

![image-20200326091305597](https://tva1.sinaimg.cn/large/00831rSTgy1gd728c3x59j30hh067dhl.jpg)

其中流控有两种模式，①被动流先通过计算最大流量差，设置最大缓存（使用FIFO，RAM），输入输出之间不需要管数据缓存够不够问题，②主动流控上流通过请求信号（enable）下游通过允许使能信号（grant）进行交互，形成主动交互。

**2.1 被动流控** 

主体是FIFO，同时有单个双口RAM或乒乓RAM进行交互。会发现：在FPGA中，这种实现方式没有太大问题，但在ASIC中用多个小RAM块不如用单个大RAM块经济，双口RAM不如单口RAM经济。因此后续又出现了用一块RAM完成双RAM乒乓操作的情况。将原来的两个RAM块合成一块，通过地址线的高低位控制实现不同区域的数据读写，详情如图1-77所示。

![image-20200326101002313](https://tva1.sinaimg.cn/large/00831rSTgy1gd73vl9acuj30ld097tbu.jpg)

![image-20200326101019927](https://tva1.sinaimg.cn/large/00831rSTgy1gd73vvszmrj30lo0an425.jpg)

然而,上述乒乓RAM没有解决模块处理数据速率不匹配的问题。例如LTE系统中主控板单个网络处理器核(NP)的包交换处理能力为1MPPS( Packet Per Second),平均每个20MHz  小区的传输需求大致在500kPS,单基站通常需要处理6个小区,因此汇聚到主控板的总速  率大致在3MPPS。基站交换需求与NP的处理能力不匹配,此时就需要通过NP核并行处理以  及输人、输出流控的方法实现速率匹配。实现原理如图1-78所示。

![image-20200326101755065](https://tva1.sinaimg.cn/large/00831rSTgy1gd743sczc6j30hn0afad5.jpg)

这类电路在LTE基站设计中非常常见,通常采用FPGA实现。目前的多核网络处理器芯片内部也是采用类似机制以提高整体处理能力。现有的100Gbps以太网标准也采用类似的思  想实现:通过4个25Gbps的串行流绑定实现100Gbps的总传输速率。目前常用的10Gbs传  输标准也支持通过4个2.5Gbps的串行流绑定实现。因此掌握这种绑定技巧也是一个设计复杂电路的基本功。

**2.2 主动流控**

主动流控是指收发双方遵守一定的协议规范,通过交互实现数据的可靠传递。这类交互通常包括一个读写状态指示(相当于读写请求)、数据是否准备好(相当于READY信号)和读写周期结束信号。

图1-79是 Intel8086对外读取数据(IO或存储器)的时序图,体现了主动流控的思想。

![image-20200326102257844](https://tva1.sinaimg.cn/large/00831rSTgy1gd7491k7v8j30qj0j1afx.jpg)

通常情况下CPU的工作频率很高,而存储器读写速度相对较低,因此当CPU对存储器发出读写指令时,存储器往往会拉低 READY信号线,表示数据没有准备好,此时CPU将进入读写等  待周期,直到 READY信号被再次拉高。若 READY信号为高电平,则表示存储器已经准备好数  据并放置于AD总线上了。这就是一种协议交互,能够根据读写双方的工作速度进行配合。

##### 3. 数据流的总线接口

前面两种流控方式(主动、被动)适合局部电路设计。一旦信号数量很多,而且面对多个设备时,就需要采用总线形式的接口,而目前常见的总线形式包括 Local Bus、AMBA（AHB/AXI等）、CoreConnect、Wishbone等。其中，Local Bus就是将所有的部件充当存储器或者10方式访问；而AHB/AXI则是目前SoC芯片的事实总线标准；CoreConnect主要在IBM与Freescale（NXP)的芯片中使用；Wishbone则主要用于开源系统，例如Opencores的设计中。下面简单介绍高速总线AHB、低速总线APB的用法以及时序特征。

一个利用AMBA总线设计的例子如图1-80所示。

![image-20200326103116513](https://tva1.sinaimg.cn/large/00831rSTgy1gd74hof9r4j30my0dyaep.jpg)

图1-80是一个基于单层AMBA总线的SoC设计例子,很容易发现在总线上添加模块或者外设是一件非常简单的事情,即使是CPU也很容易替换。例如, ARM CPU可以轻松替换为兼  容AMBA总线的 MIPS CPU,而无须重新设计外围器件;当总线上需要添加一个串口或者鼠标  接口时,直接接挂到APB总线上即可。基于总线的设计思想,就是将原来多对多传输进行解  耦,最后通过标准代理(即总线)实现聚合。

由于外围设备的访问速度有高有低,所以AMBA总线设计了高速的AHB和兼容低速设备的APB总线。但由于AHB的读写效率较低,而APB总线则过于简单,所以后续的AXB3.0/4.0标  准对此进行了改进,改进方向包括:添加传输通道以及单向化、异步桥接效率、突发地址传输、  乱序并发等方面。但无论如何,掌握 AHB/ APB总线协议是当前SoC设计的一个基础前提。

1. **AHB总线**

AHB作为高性能总线,主要包括如下特性:①单个时钟边沿操作;②非三态的实现方式; ③支持突发传输;④支持分段传输;⑤支持多个主控制器;⑥可配置32~128位总线宽度;  ⑦支持字节、半字节和字的传输。        

AHB系统由主模块、从模块和基础构架( Infrastructure)三部分组成。整个AHB总线上的传输都由主模块发出,由从模块负责回应。基础结构则由仲裁器( Arbiter)、主模块到从模  块的多路器、从模块到主模块的多路器、译码器( Decoder)、虚拟从模块( Dummy Slave)、虚拟主模块( Dummy Master)所组成。可以认为AHB的构架设计就是带优先级的多路选择器的设计

AHB总线的互连结构如图1-81所示。

 ![img](https://tva1.sinaimg.cn/large/00831rSTgy1gd75idu983j30ku0l8dic.jpg)

AHB的信号名称均为标准约定名称,每个都有特定含义,具体如表1-10所示。

| 名称                            | 来源       | 描述                                                         |
| ------------------------------- | ---------- | ------------------------------------------------------------ |
| HCLK(总线时钟)                  | 时钟源     | 为所有总线传输提供时钟基准。所有信号时序都和HCLK的上升沿相关 |
| HRESETn(复位)                   | 复位控制器 | 总线复位信号,用来复位系统和总线。这是唯一的低电平有效信号    |
| HADDR\[31:0\](地址总线)         | 主设备     | 32位系统地址总线,所有从地址均按该地址格式进行编排            |
| HTRANS\[1:0\](传输类型)         | 主设备     | 表示当前传输的类型,可以是不连续、连续、空闲和忙              |
| HWRITE(传输方向)                | 主设备     | 当该信号为高电平时表示一个写传输,为低电平时表示一个读传输    |
| HSIZE\[2:0\](传输大小)          | 主设备     | 表示传输的大小,典型情况是字节、半字或者字。协议允许最大传输字节为128字节 |
| HBURST\[2:0](突发类型)          | 主设备     | 表示传输是否组成了突发的一部分。支持4/8/16个节拍的突表示传输是否组成了突发的一部分。支持4/8/16个节拍的突发传输,并且突发传输可以是增量或者回环 |
| HPROT\[3:0](保护控制)           | 主设备     | 提供总线访问的附加信息,指示当前传输是否为预取指或者数据传输,同时也表示传输是保护模式访问还是用户模式  访问。对带存储器管理单元的总线主设备而言,这些信号也  用来指示当前传输是高速缓存的( Cache)还是缓冲的(Buf  er),主要是给那些希望执行某种保护级别的模块使用 |
| HWDATA\[31:0](写数据总线)       | 主设备     | 写数据总线。在写操作期间,主设备给从设备传输数据。AXI总线对此有改进 |
| HSELx(从设备选择)               | 译码器     | 每个AHB从设备都有自己独立的从设备选择信号,并且用该信号来表示当前传输数据是否打算送给选中的从设备。该  信号根据地址进行组合译码,实质上是地址比较器 |
| HRDATA\[31:0](读数据总线)从设备 | 从设备     | 读数据总线。在读操作期间,从设备向主设备传输数据              |
| HREADY(传输完成)                | 从设备     | 当 HREADY为高时表示总线上的传输已经完成。在扩展传输时,该信号可能会被拉低。通常从设备将该信号作为传输  数据是否准备好的标志 |
| HRESP1:0(传输响应)              | 从设备     | 从设备提供的传输附加信息。提供4种不同的响应:OKEY、ERROR、 RETRY和 SPLIT |

AHB总线读写的基本时序图如图1-82所示。

![image-20200326105647996](https://tva1.sinaimg.cn/large/00831rSTgy1gd7588hcaqj30ib0e1ad0.jpg)